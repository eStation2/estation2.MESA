FROM ubuntu:18.04 AS ubuntu
#FROM d-registry.jrc.it:5000/public/httpd-wsgi2-ubu:latest

USER root

#Setup user
ARG UID
ARG GID

#ARG http_proxy=http://10.168.209.72:8012
#ARG https_proxy=http://10.168.209.72:8012
#ARG ftp_proxy=http://10.168.209.72:8012
#ARG no_proxy="127.0.0.1, localhost, jrc.ec.europa.eu, jrc.it, jrc.org"
ARG DEBIAN_FRONTEND=noninteractive

RUN apt update && apt install -y software-properties-common
RUN add-apt-repository ppa:ubuntugis/ppa -y

# Add Apache2 with mod-wsgi and Python3  - not available python3.7-dev python3.7-tk 
RUN apt-get update && apt-get install -y apache2 apache2-dev python3-dev python3-pip libapache2-mod-wsgi-py3 locales

# Optional Development packages
RUN apt-get install -y make cmake gcc nano vim wget git unzip

# Add essential packages
RUN apt-get install -y build-essential ca-certificates libcurl4-openssl-dev libssl-dev

# Add GDAL and mapscript: python-mapscript
RUN apt-get install -y gdal-bin libgdal-dev libgeos-dev libproj-dev proj-bin python3-gdal python3-mapscript
# RUN export CPLUS_INCLUDE_PATH=/usr/include/gdal && export C_INCLUDE_PATH=/usr/include/gdal

# Set python command to installed version 3.6.9, by default the python command is python3!
RUN rm -f /usr/bin/python && ln -s /usr/bin/python3.6 /usr/bin/python

# Install all needed Python packages, listed in the file requirements.txt
ADD requirements.txt /etc/apache2/sites-available/requirements.txt
RUN pip3 install --upgrade pip
# some packages depend on setuptools to be installed. the reqiurements.txt does not preserve the order of install so install setuptools before the requirements.txt
RUN pip3 install setuptools
RUN pip3 install -r /etc/apache2/sites-available/requirements.txt
RUN pip3 install --upgrade numpy

# Update all outdated packages
# RUN pip3 list --outdated --format=freeze | grep -v '^\-e' | cut -d = -f 1  | xargs -n1 pip install -U

ADD 00-default.conf /etc/apache2/sites-available/00-default.conf
# ADD basic_security_directives.conf /etc/apache2/sites-available/basic_security_directives.conf
# ADD cookies_httponly.conf /etc/apache2/sites-available/cookies_httponly.conf

RUN ln -s /etc/apache2/sites-available/00-default.conf /etc/apache2/sites-enabled/00-default.conf && \
    mkdir -p /var/empty && unlink /etc/apache2/sites-enabled/000-default.conf
    # ln -s /etc/apache2/sites-available/basic_security_directives.conf /etc/apache2/sites-enabled/basic_security_directives.conf && \
    # ln -s /etc/apache2/sites-available/cookies_httponly.conf /etc/apache2/sites-enabled/cookies_httponly.conf && \
    # ln -s /etc/apache2/sites-available/X-XSS-Protection.conf /etc/apache2/sites-enabled/X-XSS-Protection.conf && \
    

# Add and enable virtualhost site
ADD estation2.conf /etc/apache2/sites-available/estation2.conf
RUN ln -s /etc/apache2/sites-available/estation2.conf /etc/apache2/sites-enabled/estation2.conf


# SNAP Installation
#ADD esa-snap_all_unix_7_0.sh /tmp
#RUN /tmp/esa-snap_all_unix_7_0.sh -q -dir "/usr/local"


# Configuring web folder tree
RUN mkdir -p /var/www/estation2 && mkdir -p /var/log/apache2/
#ENV APACHE_RUN_USER www-data
#ENV APACHE_RUN_GROUP www-data

# Enable these Apache modules
RUN a2enmod headers rewrite proxy wsgi
RUN service apache2 restart
WORKDIR /var/www

CMD apache2ctl -D FOREGROUND
EXPOSE  80


#ADD pythonpath /pythonpath
#RUN PYTHONPATH=$(cat /pythonpath);
#COPY docker-entrypoint.sh /usr/local/bin/
#RUN ln -s /usr/local/bin/docker-entrypoint.sh /
#ADD docker-entrypoint.sh /docker-entrypoint.sh
#ADD setup_pythonenvironment.sh /setup_pythonenvironment.sh
#ENV PYTHONPATH "${PYTONPATH}:/var/www/estation2"
#CMD [ "python", "-c", "import sys; sys.path.append('/var/www/estation2')" ]
#ENTRYPOINT /docker-entrypoint.sh
#ENTRYPOINT ["docker-entrypoint.sh"]
#ENTRYPOINT /setup_pythonenvironment.sh


# Enable apache mod_proxy
#RUN a2enmod proxy && \
#    a2enmod proxy_http && \
#    a2enmod proxy_balancer && \
#    a2enmod lbmethod_byrequests

# DEVELOPMENT TOOLS
#RUN export UNAME=jvantklooster && \
#    useradd $UNAME -u 1004 && \
#    mkdir /home/$UNAME && \
#    cp /etc/skel/.bashrc /home/$UNAME/ && \
#    cp /etc/skel/.profile /home/$UNAME/ && \
#    cp /etc/skel/.profile /home/$UNAME/.bash_profile && \
#    echo "cd /var/www" >> /home/$UNAME/.bashrc && \
#    chown -R $UNAME /home/$UNAME && \
#    echo su -l $UNAME -s /bin/bash >> /root/.bashrc

