#FROM ubuntu:18.04 AS ubuntu
FROM continuumio/miniconda3

USER root

ARG DEBIAN_FRONTEND=noninteractive

# Add essential() packages
RUN apt-get update && apt-get install -y make cmake gcc
RUN apt update && apt install -y software-properties-common wget unzip

# Add optional packages (May not needed for JEOBATCH)
#RUN apt-get update && apt-get install -y nano vim git iputils-ping locales mlocate
#RUN apt-get update && apt-get install -y build-essential ca-certificates libcurl4-openssl-dev libssl-dev
# To have locate work
#RUN updatedb

# env to run the CONDA
ENV PATH="/root/miniconda3/bin:${PATH}"
ARG PATH="/root/miniconda3/bin:${PATH}"

# Initialize conda in bash config files:
#RUN conda init bash

# Create the Conda environment from the JEODESK env file
ADD ./build-jeodpp/web_jeobatch/eStation2_environment.yml /tmp/eStation2_environment.yml
RUN conda env create -f /tmp/eStation2_environment.yml
SHELL ["conda", "run", "-n", "eStation2", "/bin/bash", "-c"]

# Add GDAL from conda-forge -> gdal contains gdal-bin libgdal-dev (May not needed for JEOBATCH)
#RUN conda update conda
#RUN conda install conda-forge::gdal

# Add GEOS and PROJ from apt-get -> needed for mapscript (May not needed for JEOBATCH)
#RUN apt-get update && apt-get install -y libgeos-dev libproj-dev proj-bin

# SNAP Installation --> Needed for the production
#RUN wget http://step.esa.int/downloads/7.0/installers/esa-snap_all_unix_7_0.sh
#ADD esa-snap_all_unix_7_0.sh /tmp
#RUN chmod 755 -R /tmp
#RUN /tmp/esa-snap_all_unix_7_0.sh -q -dir "/usr/local"

# Configuring web folder tree
RUN mkdir -p /var/www/estation2 && mkdir -p /var/log/apache2/

ADD ./src /var/www/estation2
WORKDIR /var/www/estation2

##########################################################
###### TO RUN THE SERVICE DIRECTLY IN THE CONTAINER  #####
##########################################################
# Debug entry point TOBE removed
ENTRYPOINT ["conda", "run", "-n", "eStation2", "python", "/var/www/estation2/run.py"]
# Production entry point to start the service:
#ENTRYPOINT ["conda", "run", "-n", "eStation2", "python", "/var/www/estation2/apps/acquisition/drive_get_ingest_jeodpp.py"]





